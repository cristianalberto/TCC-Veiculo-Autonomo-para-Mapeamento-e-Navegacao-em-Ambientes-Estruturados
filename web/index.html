<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mapa â€” VeÃ­culo AutÃ´nomo</title>

<style>
/* ------------------------------ */
/*           TEMAS                */
/* ------------------------------ */

:root[data-theme="dark"]{
  --bg:#0f1117;
  --card:#151924;
  --muted:#8a8f98;
  --fg:#e6e8eb;
  --accent:#4ea1ff;

  --c0:#7a7f87;
  --c1:#29c162;
  --c2:#ff5d5d;
  --c3:#ffd44d;

  --gap:#0b0e15;
  --input-bg:#0f1320;
  --input-border:#26314a;
  --button-bg:#0f1320;
  --button-border:#26314a;
  --log-bg:#0f1320;
  --grid-bg:#0f1320;
}

:root[data-theme="light"]{
  --bg:#ffffff;
  --card:#f7f7f9;
  --muted:#6b6f76;
  --fg:#111111;
  --accent:#0066cc;

  --c0:#c8cdd3;
  --c1:#39c16b;
  --c2:#ff4a4a;
  --c3:#f4c335;

  --gap:#d0d3d8;
  --input-bg:#ffffff;
  --input-border:#d1d1d1;
  --button-bg:#ffffff;
  --button-border:#cccccc;
  --log-bg:#ffffff;
  --grid-bg:#ffffff;
}

/* ------------------------------ */
/*       ESTILOS GERAIS           */
/* ------------------------------ */

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell;
}

header{
  padding:14px 18px;
  border-bottom:1px solid #ccc;
  background:var(--card);
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

h1{margin:0;font-size:18px;font-weight:600}

#themeToggle{
  padding:8px 14px;
  border-radius:8px;
  background:var(--button-bg);
  border:1px solid var(--button-border);
  color:var(--fg);
  cursor:pointer;
}
#themeToggle:hover{
  border-color:var(--accent);
}

main{
  padding:16px;
  max-width:1200px;
  margin:0 auto;
}

.grid2{
  display:grid;
  grid-template-columns:1.2fr .8fr;
  gap:16px;
}

.card{
  background:var(--card);
  border:1px solid var(--input-border);
  border-radius:12px;
  padding:12px;
}

.label{
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}

input[type="text"]{
  width:100%;
  padding:10px 12px;
  background:var(--input-bg);
  color:var(--fg);
  border:1px solid var(--input-border);
  border-radius:10px;
  outline:none;
}
input[type="text"]:focus{
  border-color:var(--accent);
}

input[type="range"]{
  width:140px;
}

button{
  background:var(--button-bg);
  color:var(--fg);
  border:1px solid var(--button-border);
  padding:10px 12px;
  border-radius:10px;
  cursor:pointer;
}
button:hover{
  border-color:var(--accent);
}

.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}

.kv{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px 12px;
  font-size:14px;
}

.dot{
  width:10px;height:10px;border-radius:50%;
  display:inline-block;vertical-align:middle;margin-right:6px
}
.ok{background:#29c162}
.warn{background:#ffb020}
.err{background:#ff5d5d}

.mono{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}

#logs{
  height:206px;
  overflow:auto;
  background:var(--log-bg);
  border:1px solid var(--input-border);
  border-radius:8px;
  padding:8px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:12px;
}

textarea{
  width:100%;
  min-height:84px;
  margin-top:8px;
  background:var(--input-bg);
  border:1px solid var(--input-border);
  color:var(--fg);
  border-radius:8px;
  padding:8px;
}

/* GRID */
#gridWrap{
  border:1px solid var(--input-border);
  border-radius:10px;
  padding:8px;
  background:var(--grid-bg);
}

#matrixGrid{
  display:grid;
  gap:1px;
  background:var(--gap);
  grid-template-columns: repeat(var(--cols,1), 1fr);
  grid-auto-rows: var(--cell, 22px);
}

.cell{
  width:100%;
  height:var(--cell, 22px);
}

.v0{background:var(--c0)}
.v1{background:var(--c1)}
.v2{background:var(--c2)}
.v3{background:var(--c3)}

.legend{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-top:8px;
  color:var(--muted);
  font-size:13px;
}

.swatch{
  width:14px;height:14px;border-radius:3px;display:inline-block;margin-right:4px;
}
</style>
</head>

<body>

<header>
  <h1>Mapa â€” VeÃ­culo AutÃ´nomo</h1>
  <button id="themeToggle">ðŸŒž Tema claro</button>
</header>

<main>
  <div class="grid2">
    <section class="card">
      <div class="label">Endpoint da API</div>
      <div class="row">
        <input id="apiBase" type="text" value="http://3.140.173.157:8000"/>
        <button id="saveBase">Salvar</button>
        <button id="refreshBtn">Atualizar</button>
        <span class="label" style="margin-left:auto">Tamanho do quadrado</span>
        <input id="cellSize" type="range" min="10" max="40" value="22"/>
        <span id="cellPx" class="mono" style="min-width:36px;text-align:right">22px</span>
      </div>

      <div class="kv" style="margin-top:8px;">
        <div><span class="label">Status MQTT</span><div id="mqttStatus"><span class="dot err"></span>desconhecido</div></div>
        <div><span class="label">Status WebSocket</span><div id="wsStatus"><span class="dot err"></span>desconectado</div></div>
        <div><span class="label">Ãšltima atualizaÃ§Ã£o</span><div id="lastUpdate" class="mono">â€”</div></div>
        <div><span class="label">Origem</span><div id="lastSource" class="mono">â€”</div></div>
        <div><span class="label">DimensÃµes</span><div id="dimensions" class="mono">0 x 0</div></div>
        <div><span class="label">Assinantes (WS)</span><div id="wsCount" class="mono">0</div></div>
      </div>

      <div style="margin-top:12px;">
        <div class="label">Modo AutomÃ¡tico (ESP32)</div>
        <div class="row">
          <button id="btnAutoOff">Desligar</button>
          <button id="btnAutoOn">Ligar</button>
        </div>

        <div class="legend">
          <span><span class="swatch" style="background:var(--c2)"></span>2 Bloqueado</span>
          <span><span class="swatch" style="background:var(--c1)"></span>1 Livre</span>
          <span><span class="swatch" style="background:var(--c0)"></span>0 NÃ£o explorado</span>
          <span><span class="swatch" style="background:var(--c3)"></span>3 Carrinho</span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="label">Logs</div>
      <div id="logs"></div>
      <div class="row" style="margin-top:8px;">
        <button id="clearLogs">Limpar logs</button>
        <span class="label">Publicar manual (debug)</span>
        <input id="topicInput" type="text" value="comando/esp"/>
        <button id="btnPublish">Publicar</button>
      </div>
      <textarea id="payloadInput">{ "cmd": "auto", "value": false, "source": "site" }</textarea>
    </section>
  </div>

  <section class="card" style="margin-top:16px;">
    <div class="label">Matriz</div>
    <div id="gridWrap">
      <div id="matrixGrid"></div>
    </div>
  </section>
</main>

<script>
(function(){
  const qs = s => document.querySelector(s);
  const logEl = qs("#logs");
  const log = m => { const ts=new Date().toLocaleTimeString(); logEl.textContent += `[${ts}] ${m}\n`; logEl.scrollTop=logEl.scrollHeight; };

  // API base
  const apiInput=qs("#apiBase");
  const saved=localStorage.getItem("apiBase"); 
  if(saved) apiInput.value=saved;

  qs("#saveBase").onclick=()=>{ 
    localStorage.setItem("apiBase",apiInput.value); 
    log("API base salva."); 
    reconnectWS(); 
    refreshAll(); 
  };
  qs("#refreshBtn").onclick=()=> refreshAll();
  qs("#clearLogs").onclick=()=>{ logEl.textContent=""; };

  // Cell size control
  const sizeInput = qs("#cellSize");
  const sizeLabel = qs("#cellPx");
  function applyCellSize(px){
    const g = qs("#matrixGrid");
    g.style.setProperty("--cell", px+"px");
    sizeLabel.textContent = px+"px";
  }
  applyCellSize(sizeInput.value);
  sizeInput.oninput = (e)=> applyCellSize(e.target.value);

  function apiBase(){ return apiInput.value.replace(/\/+$/,""); }

  // Status helpers
  function setMqttStatus(ok){ qs("#mqttStatus").innerHTML = `<span class="dot ${ok?'ok':'err'}"></span>${ok?'conectado':'desconectado'}`; }
  function setWsStatus(text,cls){ qs("#wsStatus").innerHTML = `<span class="dot ${cls}"></span>${text}`; }

  // Publishing via API
  async function publish(topic, payload, opts={}){
    const body = {
      topic,
      payload: (typeof payload==="string")?payload:JSON.stringify(payload),
      qos: opts.qos ?? 0,
      retain: opts.retain ?? false
    };
    try{
      const res = await fetch(`${apiBase()}/publish`,{
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      log(`Publicado em ${topic}: ${body.payload}`);
      return true;
    }catch(e){
      log(`Falha ao publicar em ${topic}: ${e}`);
      return false;
    }
  }

  qs("#btnPublish").onclick = ()=>{
    const topic = qs("#topicInput").value.trim() || "comando/esp";
    let payload = qs("#payloadInput").value;
    try{ payload = JSON.parse(payload); }catch{}
    publish(topic, payload);
  };

  qs("#btnAutoOn").onclick  = ()=> publish("comando/esp",{cmd:"auto",value:true,source:"site"});
  qs("#btnAutoOff").onclick = ()=> publish("comando/esp",{cmd:"auto",value:false,source:"site"});

  // MATRIX GRID
  let gridCells = []; 
  let gridRows=0, gridCols=0;

  function buildGrid(rows, cols){
    const grid = qs("#matrixGrid");
    grid.innerHTML = "";
    grid.style.setProperty("--cols", cols);
    const frag = document.createDocumentFragment();
    const total = rows*cols;
    gridCells = new Array(total);
    for(let i=0;i<total;i++){
      const d = document.createElement("div");
      d.className = "cell";
      frag.appendChild(d);
      gridCells[i] = d;
    }
    grid.appendChild(frag);
    gridRows = rows; 
    gridCols = cols;
  }

  function classFor(v){
    if (v===0) return "cell v0";
    if (v===1) return "cell v1";
    if (v===2) return "cell v2";
    if (v===3) return "cell v3";
    return "cell";
  }

  function renderMatrixGrid(matrix){
    if(!Array.isArray(matrix) || !matrix.length){
      buildGrid(0,0); 
      qs("#dimensions").textContent="0 x 0"; 
      return;
    }

    const rows = matrix.length;
    const cols = Array.isArray(matrix[0]) ? matrix[0].length : 0;
    qs("#dimensions").textContent = `${rows} x ${cols}`;

    if (rows!==gridRows || cols!==gridCols){
      buildGrid(rows, cols);
    }

    let idx=0;
    for(let r=0;r<rows;r++){
      const row = matrix[r] || [];
      for(let c=0;c<cols;c++){
        const v = row[c];
        const cell = gridCells[idx++];
        if (cell) cell.className = classFor(v);
      }
    }
  }

  // HTTP/WS
  async function refreshMatrix(){
    try{
      const res = await fetch(`${apiBase()}/matrix`);
      const data = await res.json();
      renderMatrixGrid(data.matrix);
      qs("#lastUpdate").textContent = data.last_update || "â€”";
      qs("#lastSource").textContent = data.source || "â€”";
    }catch(e){ log("Falha /matrix: "+e); }
  }

  async function refreshStats(){
    try{
      const res = await fetch(`${apiBase()}/stats`);
      const s = await res.json();
      setMqttStatus(!!s.mqtt_connected);
      qs("#wsCount").textContent = s.subscribers_ws ?? 0;
      if (s.last_update) qs("#lastUpdate").textContent = s.last_update;
      if (s.last_source) qs("#lastSource").textContent = s.last_source;
    }catch(e){ log("Falha /stats: "+e); }
  }

  async function refreshAll(){ 
    await Promise.all([refreshMatrix(), refreshStats()]); 
  }

  // WebSocket
  let ws=null, wsTimer=null, wsRetry=1000;

  function wsUrl(){
    const base=apiBase();
    if (base.startsWith("https://")) return base.replace(/^https:\/\//,"wss://")+"/ws";
    if (base.startsWith("http://"))  return base.replace(/^http:\/\//,"ws://")+"/ws";
    return `ws://${base}/ws`;
  }

  function connectWS(){
    if(ws) return;
    const url=wsUrl();
    setWsStatus("conectandoâ€¦","warn"); 
    log("WS conectando: "+url);

    try{ ws = new WebSocket(url); }
    catch(e){ 
      setWsStatus("erro","err"); 
      log("WS erro: "+e); 
      scheduleWS(); 
      return; 
    }

    ws.onopen = ()=>{
      setWsStatus("conectado","ok");
      wsRetry=1000;
      refreshAll();
    };

    ws.onclose= ()=>{
      setWsStatus("desconectado","err");
      ws=null; 
      scheduleWS();
    };

    ws.onerror= ()=> log("WS erro.");

    ws.onmessage = (ev)=>{
      try{
        const m = JSON.parse(ev.data);
        if (m.type==="hello" || m.type==="matrix_update"){
          if (m.matrix) renderMatrixGrid(m.matrix);
          if (m.last_update) qs("#lastUpdate").textContent = m.last_update;
          if (m.source) qs("#lastSource").textContent = m.source;
        }
      }catch(e){ log("WS msg invÃ¡lida: "+e); }
    };
  }

  function scheduleWS(){
    if(wsTimer) return;
    const next = Math.min(wsRetry, 15000);
    wsTimer = setTimeout(()=>{ 
      wsTimer=null; 
      wsRetry=Math.min(wsRetry*2,15000); 
      connectWS(); 
    }, next);
    log(`WS: tentando reconectar em ${Math.round(next/1000)}sâ€¦`);
  }

  function reconnectWS(){ 
    if(ws){ try{ws.close();}catch{} ws=null; } 
    connectWS(); 
  }

  // Boot
  (async ()=>{
    await refreshAll();
    connectWS();
  })();



  /* =============================
       SISTEMA DE TEMA (LIGHT/DARK)
     ============================= */

  const html = document.documentElement;
  const btnTheme = document.querySelector("#themeToggle");

  // aplica o tema salvo
  const savedTheme2 = localStorage.getItem("theme");
  if(savedTheme2){
    html.setAttribute("data-theme", savedTheme2);
    btnTheme.textContent = savedTheme2 === "light" ? "ðŸŒž Tema claro" : "ðŸŒ™ Tema escuro";
  }

  // troca tema
  btnTheme.onclick = ()=>{
    const current = html.getAttribute("data-theme");
    const next = current === "light" ? "dark" : "light";
    html.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
    btnTheme.textContent = next === "light" ? "ðŸŒž Tema claro" : "ðŸŒ™ Tema escuro";
  };

})();
</script>

</body>
</html>
